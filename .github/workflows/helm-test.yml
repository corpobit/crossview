name: Helm Chart Testing

on:
  pull_request:
    paths:
      - 'helm/**'
      - '.github/workflows/helm-test.yml'
  push:
    branches:
      - main
    paths:
      - 'helm/**'
      - '.github/workflows/helm-test.yml'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      - name: Install Helm unittest plugin
        run: |
          helm plugin install https://github.com/quintush/helm-unittest.git || true
          helm plugin update unittest || true

      - name: Run Helm Lint
        run: |
          cd helm/crossview
          helm lint .

      - name: Validate Chart Schema
        run: |
          cd helm/crossview
          helm schema validate values.schema.json || echo "Schema validation skipped (helm schema command may not be available)"

      - name: Test Template Rendering
        run: |
          cd helm/crossview
          helm template test . \
            --set secrets.dbPassword=test-password \
            --set secrets.sessionSecret=test-secret
          echo "✅ Template rendering with defaults passed"
          
          helm template test . \
            --set config.ref=existing-configmap \
            --set secrets.dbPassword=test-password \
            --set secrets.sessionSecret=test-secret
          echo "✅ Template rendering with config.ref passed"

      - name: Run Helm Unit Tests
        run: |
          cd helm/crossview
          helm unittest . || {
            echo "❌ Unit tests failed"
            exit 1
          }

      - name: Test with Different Configurations
        run: |
          cd helm/crossview
          
          echo "Testing with custom database config..."
          helm template test . \
            --set config.database.host=custom-postgres \
            --set config.database.port=5433 \
            --set secrets.dbPassword=test \
            --set secrets.sessionSecret=test > /dev/null
          
          echo "Testing with SSO enabled..."
          helm template test . \
            --set config.sso.enabled=true \
            --set config.sso.oidc.enabled=true \
            --set secrets.dbPassword=test \
            --set secrets.sessionSecret=test > /dev/null
          
          echo "Testing with existing secret..."
          helm template test . \
            --set secrets.existingSecret=my-secret \
            --set secrets.dbPassword=test \
            --set secrets.sessionSecret=test > /dev/null
          
          echo "✅ All configuration tests passed"

      - name: Test Summary
        run: |
          echo "✅ All Helm chart tests passed!"
          echo ""
          echo "Test coverage:"
          echo "  - Helm lint"
          echo "  - Schema validation"
          echo "  - Template rendering (defaults)"
          echo "  - Template rendering (config.ref)"
          echo "  - Unit tests (helm-unittest)"
          echo "  - Custom configurations"

